# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ö—ç—à-—Ç–∞–±–ª–∏—Ü—ã
## ‚ö°–ì–∞—Ä—Ä–∏ –ü–æ—Ç—Ç–µ—Ä –∏ —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π –∫–∞–º–µ–Ω—å
–ß–∞—Å—Ç–æ—Ç–∞ –ø–æ—è–≤–ª–µ–Ω–∏—è "Harry" - 1327, "Ron" - 429, "Hermione" - 270. –û—Ç–∫—É–¥–∞ –∏–Ω—Ñ–æ—Ä—Ä–º–∞—Ü–∏—è ? - –•—ç—à - —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞—à–ª–∞:)
## üìå –¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞
–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ö–µ—à-—Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Å—Ç—Ä–æ–∫ —Å –∞–Ω–∞–ª–∏–∑–æ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ö–µ—à-—Ñ—É–Ω–∫—Ü–∏–π –∏ –º–µ—Ç–æ–¥–æ–≤ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.

## üîç –ó–∞–¥–∞—á–∏

–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É—è —Ç—Ä–∏ –º–µ—Ç–æ–¥–∞:

- **–ß–∏—Å—Ç—ã–π –∞—Å—Å–µ–º–±–ª–µ—Ä** ‚Äî –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ —á–∞—Å—Ç–∏ –∫–æ–¥–∞ –Ω–∞ ASM.  
- **–ê—Å—Å–µ–º–±–ª–µ—Ä–Ω—ã–µ –≤—Å—Ç–∞–≤–∫–∏** ‚Äî —Ç–æ—á–µ—á–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.  
- **SIMD-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏** ‚Äî –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π (SSE/AVX).  

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—ë–º –∞—Å—Å–µ–º–±–ª–µ—Ä–Ω–æ–≥–æ –∫–æ–¥–∞.  
- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ —Ñ–æ—Ä–º—É–ª–µ:  

–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É–ª—É—á—à–µ–Ω–∏—è = (–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∫–æ—Ä–µ–Ω–∏—è / –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Å—Å–µ–º–±–ª–µ—Ä–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π) * 1000

## üóÉÔ∏è –•–µ—à-—Ç–∞–±–ª–∏—Ü–∞ ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (–∫–æ—Ä–æ—Ç–∫–æ –∏ —ë–º–∫–æ)
### –ß—Ç–æ —ç—Ç–æ?
–•–µ—à-—Ç–∞–±–ª–∏—Ü–∞ ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –ø–æ –∫–ª—é—á—É. –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É:
–∫–ª—é—á ‚Üí —Ö–µ—à-—Ñ—É–Ω–∫—Ü–∏—è ‚Üí –∏–Ω–¥–µ–∫—Å –≤ –º–∞—Å—Å–∏–≤–µ ‚Üí –∑–Ω–∞—á–µ–Ω–∏–µ

2 –≥–ª–∞–≤–Ω—ã—Ö —Ç–∏–ø–∞:

- –° —Ü–µ–ø–æ—á–∫–∞–º–∏ 

–ö–∞–∂–¥–∞—è —è—á–µ–π–∫–∞ –º–∞—Å—Å–∏–≤–∞ ‚Äî –≥–æ–ª–æ–≤–∞ —Å–≤—è–∑–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞

–ö–æ–ª–ª–∏–∑–∏–∏ —Ä–µ—à–∞—é—Ç—Å—è –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–ø–∏—Å–æ–∫

–ü–ª—é—Å—ã: –ü—Ä–æ—Å—Ç–æ—Ç–∞, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ

–ú–∏–Ω—É—Å—ã: –î–æ–ø. –ø–∞–º—è—Ç—å –Ω–∞ —É–∫–∞–∑–∞—Ç–µ–ª–∏, cache misses

- –° –æ—Ç–∫—Ä—ã—Ç–æ–π –∞–¥—Ä–µ—Å–∞—Ü–∏–µ–π

–í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Å–∞–º–æ–º –º–∞—Å—Å–∏–≤–µ

–ö–æ–ª–ª–∏–∑–∏–∏ —Ä–µ—à–∞—é—Ç—Å—è –ø–æ–∏—Å–∫–æ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π —è—á–µ–π–∫–∏ (–ª–∏–Ω–µ–π–Ω—ã–π/–∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω—ã–π probing)

–ü–ª—é—Å—ã: –õ—É—á—à–∞—è –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å, –º–µ–Ω—å—à–µ –∞–ª–ª–æ–∫–∞—Ü–∏–π

–ú–∏–Ω—É—Å—ã: –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –Ω–∞–≥—Ä—É–∑–∫–µ (>70% ‚Äî —Ç–æ—Ä–º–æ–∑–∞)

###‚ö° –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç?

–ö–ª—é—á ‚Üí –•–µ—à-—Ñ—É–Ω–∫—Ü–∏—è ‚Üí –ò–Ω–¥–µ–∫—Å –≤ –º–∞—Å—Å–∏–≤–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, hash("magic") % 5147 ‚Üí 42).

–ö–æ–ª–ª–∏–∑–∏–∏ (—Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–∏ ‚Üí –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å) —Ä–µ—à–∞—é—Ç—Å—è:

–ú–µ—Ç–æ–¥ —Ü–µ–ø–æ—á–µ–∫ : –ö–∞–∂–¥—ã–π –±–∞–∫–µ—Ç ‚Äî —Å–≤—è–∑–Ω—ã–π —Å–ø–∏—Å–æ–∫.

–û—Ç–∫—Ä—ã—Ç–∞—è –∞–¥—Ä–µ—Å–∞—Ü–∏—è: –ü–æ–∏—Å–∫ —Å–ª–µ–¥—É—é—â–µ–π —Å–≤–æ–±–æ–¥–Ω–æ–π —è—á–µ–π–∫–∏.

### üìä –í–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:

–†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã: 5147 –±–∞–∫–µ—Ç–æ–≤ (–ø—Ä–æ—Å—Ç–æ–µ —á–∏—Å–ª–æ –¥–ª—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏).

–ö–ª—é—á–∏: –°—Ç—Ä–æ–∫–∏ –¥–æ 32 —Å–∏–º–≤–æ–ª–æ–≤ (WORD_SIZE).

## üî• –ù–∞—á–Ω–µ–º –∏—Å–∫–∞—Ç—å –≥–æ—Ä—è—á–∏–µ —Ç–æ—á–∫–∏

–î–ª—è –Ω–∞—á–∞–ª–∞ —É–±–µ—Ä–µ–º –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é –∏ –ø–µ—Ä–µ–≤–µ–¥–µ–º –≤—Å–µ –±—É–∫–≤—ã –≤ —Å—Ç—Ä–æ—á–Ω—ã–µ –∏ –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –∑–∞–ø–∏—Å–∞—Ç—å –∫–∞–∫ 32 –±–∞–π—Ç–∞ (–Ω–∞–º–µ–∫ –Ω–∞ ymm) –æ—Ç–¥–µ–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π (–ø–∞–ø–∫–∞ tools prepare_words.cpp), —á—Ç–æ–±—ã –∑–∞–º–µ—Ä—è—Ç—å –∏–º–µ–Ω–Ω–æ –ø–æ–∏—Å–∫. –í–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è valgrind –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ :

![–ü–µ—Ä–≤—ã–π –∑–∞–º–µ—Ä](callgrind/time_1.png)

### –ü–µ—Ä–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è hash 

```c
unsigned long hash(const char *key)
{
    assert(key);

    unsigned long hash = 5381;

    for (size_t i = 0; key[i] != '\0'; i++)

         hash = ((hash << 5) + hash) + (size_t) (key[i]); // hash * 33 + c


    return hash;
}
```

–î–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ö—ç—à-—Ñ—É–Ω–∫—Ü–∏–∏ –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å  _mm_crc32_u64

```c
uint32_t hash_intrinsic(const char* word)
{
    uint64_t hash = 0;
    hash = _mm_crc32_u64(hash, *((const uint64_t*)(word)));     //process only 4 byte
    hash = _mm_crc32_u64(hash, *((const uint64_t*)(word + 8)));
    hash = _mm_crc32_u64(hash, *((const uint64_t*)(word + 16)));
    hash = _mm_crc32_u64(hash, *((const uint64_t*)(word + 24)));
    return (uint32_t)hash;
}
```

![–í—Ç–æ—Ä–æ–π –∑–∞–º–µ—Ä](callgrind/time_2.png)


–û—Ü–µ–Ω–∏–≤–∞—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∫–æ—Ä–µ–Ω–∏—è –±—É–¥–µ–º –ø–æ Self (—Ç–∞–∫—Ç—ã —Ä–∞–±–æ—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤)

| –§—É–Ω–∫—Ü–∏—è       | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—Ç–∞–∫—Ç—ã) | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—Ç–∞–∫—Ç—ã) | –£—Å–∫–æ—Ä–µ–Ω–∏–µ |
|---------------|-----------------------|--------------------------|-----------|
| `hash()`      | 352 176 496           | 57 018 136               | **6.18√ó** |

–¢–µ–ø–µ—Ä—å —Å–∞–º–∞—è –¥–æ–ª–≥–∞—è strcmp, –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –µ–µ

### –í—Ç–æ—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è strcmp

![–í—Ç–æ—Ä–æ–π –∑–∞–º–µ—Ä](callgrind/time_3(strcmp).png)
