# –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ö—ç—à-—Ç–∞–±–ª–∏—Ü—ã
## üìå –¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞
–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ö–µ—à-—Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Å—Ç—Ä–æ–∫ —Å –∞–Ω–∞–ª–∏–∑–æ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ö–µ—à-—Ñ—É–Ω–∫—Ü–∏–π –∏ –º–µ—Ç–æ–¥–æ–≤ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.

## üîç –ó–∞–¥–∞—á–∏

–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∏—Å–ø–æ–ª—å–∑—É—è —Ç—Ä–∏ –º–µ—Ç–æ–¥–∞:

- **–ß–∏—Å—Ç—ã–π –∞—Å—Å–µ–º–±–ª–µ—Ä** ‚Äî –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ —á–∞—Å—Ç–∏ –∫–æ–¥–∞ –Ω–∞ ASM.  
- **–ê—Å—Å–µ–º–±–ª–µ—Ä–Ω—ã–µ –≤—Å—Ç–∞–≤–∫–∏** ‚Äî —Ç–æ—á–µ—á–Ω–æ–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.  
- **SIMD-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏** ‚Äî –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π (SSE/AVX).  

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –ú–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä—ë–º –∞—Å—Å–µ–º–±–ª–µ—Ä–Ω–æ–≥–æ –∫–æ–¥–∞.  
- –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∫–æ—Ä–µ–Ω–∏—è –ø–æ —Ñ–æ—Ä–º—É–ª–µ:  

–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É–ª—É—á—à–µ–Ω–∏—è = (–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∫–æ—Ä–µ–Ω–∏—è / –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Å—Å–µ–º–±–ª–µ—Ä–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π) * 1000

## üóÉÔ∏è –•–µ—à-—Ç–∞–±–ª–∏—Ü–∞ ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö 
###  üîç –ß—Ç–æ —ç—Ç–æ?
–•–µ—à-—Ç–∞–±–ª–∏—Ü–∞ ‚Äî —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –ø–æ –∫–ª—é—á—É. –†–∞–±–æ—Ç–∞–µ—Ç –ø–æ –ø—Ä–∏–Ω—Ü–∏–ø—É:
–∫–ª—é—á ‚Üí —Ö–µ—à-—Ñ—É–Ω–∫—Ü–∏—è ‚Üí –∏–Ω–¥–µ–∫—Å –≤ –º–∞—Å—Å–∏–≤–µ ‚Üí –∑–Ω–∞—á–µ–Ω–∏–µ

## –•–µ—à-—Ç–∞–±–ª–∏—Ü—ã: –ú–µ—Ç–æ–¥—ã —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∫–æ–ª–ª–∏–∑–∏–π üöÄ

–í —Ö–µ—à-—Ç–∞–±–ª–∏—Ü–∞—Ö –∫–æ–ª–ª–∏–∑–∏–∏ –Ω–µ–∏–∑–±–µ–∂–Ω—ã. –í–æ—Ç –¥–≤–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–¥—Ö–æ–¥–∞ –∫ –∏—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—é:

‚ñå1. –ú–µ—Ç–æ–¥ —Ü–µ–ø–æ—á–µ–∫ (Separate Chaining) üîó

–ö–∞–∂–¥–∞—è —è—á–µ–π–∫–∞ –º–∞—Å—Å–∏–≤–∞ ‚Äî —ç—Ç–æ –≥–æ–ª–æ–≤–∞ —Å–≤—è–∑–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞. –ö–æ–≥–¥–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∫–æ–ª–ª–∏–∑–∏—è, –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫.

–ü–ª—é—Å—ã:

‚Ä¢   –ü—Ä–æ—Å—Ç–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

‚Ä¢   –°—Ç–∞–±–∏–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–∞–∂–µ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ (–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ö–µ—à-—Ç–∞–±–ª–∏—Ü—ã).

–ú–∏–Ω—É—Å—ã:

‚Ä¢   –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å –Ω–∞ —É–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è —Å–≤—è–∑–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤.

‚Ä¢   –í–æ–∑–º–æ–∂–Ω—ã–µ cache misses –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º –ø–æ —Ä–∞–∑–Ω—ã–º —É—á–∞—Å—Ç–∫–∞–º –ø–∞–º—è—Ç–∏.

‚ñå2. –û—Ç–∫—Ä—ã—Ç–∞—è –∞–¥—Ä–µ—Å–∞—Ü–∏—è (Open Addressing) üö™

–í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –≤ —Å–∞–º–æ–º –º–∞—Å—Å–∏–≤–µ. –ü—Ä–∏ –∫–æ–ª–ª–∏–∑–∏–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–∏—Å–∫ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π —è—á–µ–π–∫–∏ –≤ –º–∞—Å—Å–∏–≤–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –ø–æ–º–æ—â—å—é –ª–∏–Ω–µ–π–Ω–æ–≥–æ –∏–ª–∏ –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω–æ–≥–æ probing).

–ü–ª—é—Å—ã:

‚Ä¢   –õ—É—á—à–∞—è –ª–æ–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (–≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ä—è–¥–æ–º –≤ –ø–∞–º—è—Ç–∏).

‚Ä¢   –ú–µ–Ω—å—à–µ –∞–ª–ª–æ–∫–∞—Ü–∏–π –ø–∞–º—è—Ç–∏ (–Ω–µ –Ω—É–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã, –∫–∞–∫ —Å–≤—è–∑–Ω—ã–µ —Å–ø–∏—Å–∫–∏).

–ú–∏–Ω—É—Å—ã:

‚Ä¢   –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –ø–∞–¥–∞–µ—Ç –ø—Ä–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã –±–æ–ª–µ–µ —á–µ–º –Ω–∞ 70%.

‚Ä¢   –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã —É–¥–∞–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–Ω—É–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å, —á—Ç–æ —è—á–µ–π–∫–∞ –º–æ–≥–ª–∞ –±—ã—Ç—å "–∑–∞–Ω—è—Ç–∞" –¥—Ä—É–≥–∏–º —ç–ª–µ–º–µ–Ω—Ç–æ–º –∏–∑-–∑–∞ –∫–æ–ª–ª–∏–∑–∏–∏).


### üìä –ú–æ—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è:

–•—ç—à-—Ç–∞–±–ª–∏—Ü–∞ –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –º–µ—Ç–æ–¥–µ —Ü–µ–ø–æ—á–µ–∫ 

–†–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã: 5147 –±–∞–∫–µ—Ç–æ–≤ (–ø—Ä–æ—Å—Ç–æ–µ —á–∏—Å–ª–æ –¥–ª—è —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏).

–ö–ª—é—á–∏: –°—Ç—Ä–æ–∫–∏ –¥–æ 32 —Å–∏–º–≤–æ–ª–æ–≤ (WORD_SIZE).

### ‚ö° –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç?

–ö–ª—é—á ‚Üí –•–µ—à-—Ñ—É–Ω–∫—Ü–∏—è ‚Üí –ò–Ω–¥–µ–∫—Å –≤ –º–∞—Å—Å–∏–≤–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, hash("magic") % 5147 ‚Üí 42).

## üî• –ù–∞—á–Ω–µ–º –∏—Å–∫–∞—Ç—å –≥–æ—Ä—è—á–∏–µ —Ç–æ—á–∫–∏

–î–ª—è –Ω–∞—á–∞–ª–∞ —É–±–µ—Ä–µ–º –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é –∏ –ø–µ—Ä–µ–≤–µ–¥–µ–º –≤—Å–µ –±—É–∫–≤—ã –≤ —Å—Ç—Ä–æ—á–Ω—ã–µ –∏ –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ –∑–∞–ø–∏—Å–∞—Ç—å –∫–∞–∫ 32 –±–∞–π—Ç–∞ (–Ω–∞–º–µ–∫ –Ω–∞ ymm) –æ—Ç–¥–µ–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π (–ø–∞–ø–∫–∞ tools prepare_words.cpp), —á—Ç–æ–±—ã –∑–∞–º–µ—Ä—è—Ç—å –∏–º–µ–Ω–Ω–æ –ø–æ–∏—Å–∫. –í–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è valgrind –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ :

![–ü–µ—Ä–≤—ã–π –∑–∞–º–µ—Ä](callgrind/time_1.png)

### –ü–µ—Ä–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è hash 

```c
unsigned long hash(const char *key)
{
    assert(key);

    unsigned long hash = 5381;

    for (size_t i = 0; key[i] != '\0'; i++)

         hash = ((hash << 5) + hash) + (size_t) (key[i]); // hash * 33 + c


    return hash;
}
```

–î–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ö—ç—à-—Ñ—É–Ω–∫—Ü–∏–∏ –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å  _mm_crc32_u64

```c
uint32_t hash_intrinsic(const char* word)
{
    uint64_t hash = 0;
    hash = _mm_crc32_u64(hash, *((const uint64_t*)(word)));     //process only 4 byte
    hash = _mm_crc32_u64(hash, *((const uint64_t*)(word + 8)));
    hash = _mm_crc32_u64(hash, *((const uint64_t*)(word + 16)));
    hash = _mm_crc32_u64(hash, *((const uint64_t*)(word + 24)));
    return (uint32_t)hash;
}
```

![–í—Ç–æ—Ä–æ–π –∑–∞–º–µ—Ä](callgrind/time_2.png)


–û—Ü–µ–Ω–∏–≤–∞—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —É—Å–∫–æ—Ä–µ–Ω–∏—è –±—É–¥–µ–º –ø–æ Self (—Ç–∞–∫—Ç—ã —Ä–∞–±–æ—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏ –±–µ–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤)

| –§—É–Ω–∫—Ü–∏—è       | –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—Ç–∞–∫—Ç—ã) | –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—Ç–∞–∫—Ç—ã) | –£—Å–∫–æ—Ä–µ–Ω–∏–µ |
|---------------|-----------------------|--------------------------|-----------|
| `hash()`      | 352 176 496           | 57 018 136               | **6.18√ó** |

–¢–µ–ø–µ—Ä—å —Å–∞–º–∞—è –¥–æ–ª–≥–∞—è strcmp, –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –µ–µ

### –í—Ç–æ—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è strcmp

–ó–∞–º–µ–Ω–∏–º —Ñ—É–Ω–∫—Ü–∏–π –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–∞ strcmp_avx2, –∏—Å–ø–æ–ª—å–∑—É—è –∏–Ω—Ç—Ä–∏–Ω—Å–∏–∫–∏ (–∑–¥–µ—Å—å –Ω–∞–º –∏ –ø—Ä–∏–≥–æ–¥–∏–ª–æ—Å—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–ª–æ–≤ –ø–æ 32 –±–∞–π—Ç–∞ )

```c
__attribute__((noinline))

int strcmp_avx2(const char *s1, const char *s2)
{
    assert(s1);
    assert(s2);

    const __m256i *ptr1 = (const __m256i*)s1;
    const __m256i *ptr2 = (const __m256i*)s2;

    __m256i vec1 = _mm256_load_si256(ptr1);
    __m256i vec2 = _mm256_load_si256(ptr2);

    uint32_t mask = _mm256_movemask_epi8(_mm256_cmpeq_epi8(vec1, vec2));
    return (mask == 0xFFFFFFFF) ? 0 : 1;
}

```
–ó–∞–æ–¥–Ω–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –µ—â–µ –æ–¥–Ω—É —Ñ—É–Ω–∫—Ü–∏–∏ - strncpy. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –Ω–∞–º —É–º–µ–Ω—å—à–∏—Ç—å –∑–∞—Ç—Ä–∞—Ç—ã –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–æ–∏—Å–∫, –Ω–æ –∏ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É.

```c
__attribute__((noinline))
void strncpy_avx2(char *dest, const char *src)
{
    const __m256i *src_vec = (const __m256i*)src;
    __m256i data = _mm256_loadu_si256(src_vec);
    _mm256_storeu_si256((__m256i*)dest, data);

    dest[WORD_SIZE-1] = '\0';
}

```

![–¢—Ä–µ—Ç–∏–π –∑–∞–º–µ—Ä](callgrind/time_3(strcmp).png)
